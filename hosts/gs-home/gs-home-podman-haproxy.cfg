global
  maxconn 1024
  log stdout format raw local0

  tune.lua.bool-sample-conversion normal
  lua-prepend-path /data/?.lua
  lua-load /data/auth-request.lua

defaults
  mode http
  log global
  option httplog

  default-server init-addr last,libc,none resolvers default
  timeout client 30s
  timeout connect 5s
  timeout server 60s

frontend public
  bind :80
  bind :443 ssl crt /certs/

  acl is_ssl ssl_fc
  acl is_trusted src 10.0.0.0/8
  acl is_www hdr_beg(host) -i www.

  acl be_auth hdr_end(host) -i auth.boarede.com
  acl be_ldap hdr_end(host) -i ldap.boarede.com
  acl be_mail hdr_end(host) -i mail.boarede.com
  acl be_vault hdr_end(host) -i vault.boarede.com
  acl be_root hdr_end(host) -i boarede.com

  http-request redirect prefix https://%[hdr(host),regsub(^www\.,,i)] code 301 if is_www
  http-request redirect scheme https code 301 unless is_ssl

  http-request del-header X-Forwarded-For unless is_trusted
  http-request set-header X-Forwarded-For %[src] unless { req.hdr(X-Forwarded-For) -m found }
  http-request set-header X-Real-IP %[src]

  http-request set-var(req.questionmark) str(?) if { query -m found }

  http-request set-header X-Forwarded-Method %[method]
  http-request set-header X-Forwarded-Proto https
  http-request set-header X-Forwarded-Host %[req.hdr(Host)]
  http-request set-header X-Forwarded-URI %[path]%[var(req.questionmark)]%[query]

  http-request lua.auth-intercept auth /api/authz/forward-auth HEAD * - - unless be_auth
  http-request deny unless be_auth || { var(txn.auth_response_successful) -m bool } || !{ var(txn.auth_response_code) -m int 403 }
  http-request redirect location %[var(txn.auth_response_location)] unless be_auth || { var(txn.auth_response_successful) -m bool }

  default_backend unknown

  use_backend auth if be_auth
  use_backend ldap if be_ldap
  use_backend mail if be_mail
  use_backend vault if be_vault
  use_backend root if be_root

backend unknown
  http-request return status 404

backend auth
  http-request return status 404 if { nbsrv eq 0 }
  server auth localhost:9091 check
backend ldap
  http-request return status 404 if { nbsrv eq 0 }
  server ldap localhost:17170 check
backend mail
  http-request return status 404 if { nbsrv eq 0 }
  server mail localhost:8082 check
backend vault
  http-request return status 404 if { nbsrv eq 0 }
  server vault localhost:8081 check
backend root
  http-request return status 404 if { nbsrv eq 0 }
  server root localhost:8080 check
